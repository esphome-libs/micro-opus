--- a/celt/celt_decoder.c
+++ b/celt/celt_decoder.c
@@ -32,6 +32,8 @@
 #endif

 #define CELT_DECODER_C
+
+#include "celt_timing.h"

 #include "cpu_support.h"
 #include "os_support.h"
@@ -1166,6 +1168,12 @@ int celt_decode_with_ec(CELTDecoder * OPUS_RESTRICT st, const unsigned char *dat
 # define qext_bytes 0
 #endif
    ALLOC_STACK;
+
+#ifdef CONFIG_OPUS_ENABLE_CELT_TIMING
+   int64_t _timing_total_start = celt_timing_get_time();
+   int64_t _timing_stage_start = 0;
+#endif
+
 #ifdef ENABLE_QEXT
    qext_scale = st->qext_scale;
 #endif
@@ -1311,6 +1319,10 @@ int celt_decode_with_ec(CELTDecoder * OPUS_RESTRICT st, const unsigned char *dat
    total_bits = len*8;
    tell = ec_tell(dec);

+#ifdef CONFIG_OPUS_ENABLE_CELT_TIMING
+   _timing_stage_start = celt_timing_get_time();
+#endif
+
    if (tell >= total_bits)
       silence = 1;
    else if (tell==1)
@@ -1453,6 +1465,10 @@ int celt_decode_with_ec(CELTDecoder * OPUS_RESTRICT st, const unsigned char *dat

    unquant_fine_energy(mode, start, end, oldBandE, NULL, fine_quant, dec, C);

+#ifdef CONFIG_OPUS_ENABLE_CELT_TIMING
+   g_celt_timing.entropy_decode_time += (celt_timing_get_time() - _timing_stage_start);
+#endif
+
    ALLOC(X, C*N, celt_norm);   /**< Interleaved normalised MDCTs */

 #ifdef ENABLE_QEXT
@@ -1484,6 +1500,10 @@ int celt_decode_with_ec(CELTDecoder * OPUS_RESTRICT st, const unsigned char *dat
    /* Decode fixed codebook */
    ALLOC(collapse_masks, C*nbEBands, unsigned char);

+#ifdef CONFIG_OPUS_ENABLE_CELT_TIMING
+   _timing_stage_start = celt_timing_get_time();
+#endif
+
    quant_all_bands(0, mode, start, end, X, C==2 ? X+N : NULL, collapse_masks,
          NULL, pulses, shortBlocks, spread_decision, dual_stereo, intensity, tf_res,
          len*(8<<BITRES)-anti_collapse_rsv, balance, dec, LM, codedBands, &st->rng, 0,
@@ -1491,6 +1511,11 @@ int celt_decode_with_ec(CELTDecoder * OPUS_RESTRICT st, const unsigned char *dat
          ARG_QEXT(&ext_dec) ARG_QEXT(extra_pulses)
          ARG_QEXT(qext_bytes*(8<<BITRES)) ARG_QEXT(cap));

+#ifdef CONFIG_OPUS_ENABLE_CELT_TIMING
+   g_celt_timing.pvq_decode_time += (celt_timing_get_time() - _timing_stage_start);
+   _timing_stage_start = celt_timing_get_time();
+#endif
+
 #ifdef ENABLE_QEXT
    if (qext_mode) {
       VARDECL(int, zeros);
@@ -1522,6 +1547,11 @@ int celt_decode_with_ec(CELTDecoder * OPUS_RESTRICT st, const unsigned char *dat
    if (anti_collapse_on)
       anti_collapse(mode, X, collapse_masks, LM, C, N,
             start, end, oldBandE, oldLogE, oldLogE2, pulses, st->rng, 0, st->arch);
+
+#ifdef CONFIG_OPUS_ENABLE_CELT_TIMING
+   g_celt_timing.energy_finalize_time += (celt_timing_get_time() - _timing_stage_start);
+   _timing_stage_start = celt_timing_get_time();
+#endif

    if (silence)
    {
@@ -1534,6 +1564,11 @@ int celt_decode_with_ec(CELTDecoder * OPUS_RESTRICT st, const unsigned char *dat
    celt_synthesis(mode, X, out_syn, oldBandE, start, effEnd,
                   C, CC, isTransient, LM, st->downsample, silence, st->arch ARG_QEXT(qext_mode) ARG_QEXT(st->qext_oldBandE) ARG_QEXT(qext_end));

+#ifdef CONFIG_OPUS_ENABLE_CELT_TIMING
+   g_celt_timing.synthesis_time += (celt_timing_get_time() - _timing_stage_start);
+   _timing_stage_start = celt_timing_get_time();
+#endif
+
    c=0; do {
       st->postfilter_period=IMAX(st->postfilter_period, COMBFILTER_MINPERIOD);
       st->postfilter_period_old=IMAX(st->postfilter_period_old, COMBFILTER_MINPERIOD);
@@ -1595,7 +1630,18 @@ int celt_decode_with_ec(CELTDecoder * OPUS_RESTRICT st, const unsigned char *dat
    if (qext_bytes) st->rng = st->rng ^ ext_dec.rng;
 #endif

+#ifdef CONFIG_OPUS_ENABLE_CELT_TIMING
+   g_celt_timing.postfilter_time += (celt_timing_get_time() - _timing_stage_start);
+   _timing_stage_start = celt_timing_get_time();
+#endif
+
    deemphasis(out_syn, pcm, N, CC, st->downsample, mode->preemph, st->preemph_memD, accum);
+
+#ifdef CONFIG_OPUS_ENABLE_CELT_TIMING
+   g_celt_timing.deemphasis_time += (celt_timing_get_time() - _timing_stage_start);
+   g_celt_timing.total_time += (celt_timing_get_time() - _timing_total_start);
+   CELT_TIMING_PRINT(200);
+#endif
    st->loss_duration = 0;
    st->plc_duration = 0;
    st->last_frame_type = FRAME_NORMAL;
